<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QRBus</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 2em;
      text-align: center;
    }
    h1 {
      margin-bottom: 0.5em;
    }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 1em;
    }
    li {
      padding: 0.4em;
      font-size: 1.4em;
      cursor: pointer;
    }
    li:hover {
      background-color: #eee;
    }
    .line {
      font-weight: bold;
    }
    #map {
      height: 300px;
      margin-top: 1.5em;
      border-radius: 8px;
      display: none;
    }
    @media (max-width: 600px) {
      body {
        padding: 1em;
      }
      li {
        font-size: 1.1em;
        padding: 0.3em;
      }
      h1 {
        font-size: 1.3em;
      }
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
</head>
<body>
  <h1 id="stopName">Loading‚Ä¶</h1>
  <div id="status">‚è≥ Loading departures...</div>
  <ul id="times"></ul>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const stopId = new URLSearchParams(location.search).get("id") || "Lappeenranta:205390";
    const apiRoot = "http://127.0.0.1:5000";

    let map = L.map("map").setView([61.06, 28.1], 13);
    let routeLayer = null, busMarker = null;
    map.addLayer(L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));
    document.getElementById("map").style.display = "none";

    function formatTime(mins, live) {
      if (mins <= 20) return `${mins} ${live ? "‚ö°" : "‚è∞"}`;
      const future = new Date(Date.now() + mins * 60000);
      const hh = future.getHours().toString().padStart(2, '0');
      const mm = future.getMinutes().toString().padStart(2, '0');
      return `${hh}:${mm} üïí`;
    }

    function groupByLine(data) {
      const map = {};
      data.forEach(({ line, head, mins, live }) => {
        const key = `${line} ‚Üí ${head}`;
        if (!map[key]) map[key] = [];
        map[key].push({ mins, live });
      });
      return map;
    }

    async function loadStop() {
      try {
        const res = await fetch(`${apiRoot}/api/stop/${encodeURIComponent(stopId)}`);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();

        document.getElementById("stopName").textContent = data.name;
        const now = Math.floor(Date.now() / 1000);
        const norm = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        const stopNorm = norm(data.name);
        const list = [];

        data.stoptimesWithoutPatterns.forEach(st => {
          const sn = st.trip.route.shortName;
          const head = st.trip.tripHeadsign || "";
          const headNorm = norm(head);
          const arrSec = st.realtime ? st.realtimeArrival : st.scheduledArrival;
          const mins = Math.floor((st.serviceDay + arrSec - now) / 60);
          if (mins < 0 || mins > 120) return;
          if (
            (stopNorm.includes("yliopisto") && headNorm.includes("yliopisto")) ||
            (stopNorm.includes("matkakeskus") && headNorm.includes("matkakeskus"))
          ) return;
          list.push({ line: sn, head, mins, live: st.realtime });
        });

        const grouped = groupByLine(list);
        const ul = document.getElementById("times");
        ul.innerHTML = "";
        Object.entries(grouped).forEach(([key, arr]) => {
          const li = document.createElement("li");
          li.innerHTML = `<span class="line">${key}</span> ‚Äî ` +
            arr.sort((a,b)=>a.mins-b.mins).map(v => formatTime(v.mins, v.live)).join(", ");

          li.onclick = () => {
            const shortName = key.split(" ‚Üí ")[0];
            const stop = encodeURIComponent(stopId);
            window.open(`map.html?route=${shortName}&stop=${stop}`, "_blank");
          };

          ul.appendChild(li);  // ‚Üê sadece burada √ßaƒürƒ±lmalƒ±
        });
        document.getElementById("status").textContent = list.length
          ? ""
          : "‚è≥ No vehicle on route yet";
      } catch (err) {
        document.getElementById("stopName").textContent = "Error";
        document.getElementById("status").textContent = "üõë Could not load stop data";
        console.error(err);
      }
    }

    async function showRoute(shortName) {
      const routeId = `Lappeenranta:${shortName}`;
      try {
        const res = await fetch(`${apiRoot}/api/route/${routeId}/stops`);
        if (!res.ok) throw new Error(await res.text());
        const stops = await res.json();
        if (!stops.length) return;

        if (routeLayer) map.removeLayer(routeLayer);
        if (busMarker) map.removeLayer(busMarker);
        const latlngs = stops.map(s => [s.lat, s.lon]);
        routeLayer = L.polyline(latlngs, { color: "blue", weight: 5 }).addTo(map);
        map.fitBounds(routeLayer.getBounds());
        document.getElementById("map").style.display = "block";

        const resVeh = await fetch(`${apiRoot}/api/route/${routeId}/vehicles`);
        const vehicles = await resVeh.json();
        if (vehicles.length) {
          const v = vehicles[0];
          busMarker = L.marker([v.lat, v.lon]).addTo(map);
        }
      } catch (err) {
        console.error("Show route error", err);
      }
    }

    loadStop();
    setInterval(loadStop, 30000);
  </script>
<div style="margin-top: 2em;">
  <a href="https://waltti.fi/en/" target="_blank" rel="noopener" style="font-size: 1.1em; text-decoration: none; color: #0077cc;">
    üí≥ Check or top up your Waltti card ¬∑ Tarkista tai lataa Waltti-korttisi
  </a>
</div>
</body>
</html>